var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import"./main-Dacpvxy9.js";import"./game-top-bar-D2G5Ym00.js";class s{constructor(){t(this,"name"),t(this,"ready"),this.name="Player"+Math.floor(1e3*Math.random()),this.ready=!1}}class i{constructor(e,s){t(this,"id"),t(this,"playerSlots"),t(this,"timeJoined"),t(this,"aiEligible"),t(this,"classId"),t(this,"onDelete"),t(this,"previousAllReady",!1),this.id=e,this.playerSlots=[null,null,null],this.timeJoined=0,this.aiEligible=!1,this.classId=0,this.onDelete=s,this.createLobbyElement()}get allReady(){return this.playerSlots.some(e=>null!==e)&&this.playerSlots.every(e=>null===e||e.ready)}checkAndFireReadyStatusChange(){const e=this.allReady;if(e!==this.previousAllReady){this.previousAllReady=e;const t=new CustomEvent("lobbyReadyStatusChanged",{detail:{lobby:this,allReady:e}});document.dispatchEvent(t)}}get playerCount(){return this.playerSlots.filter(e=>null!==e).length}addPlayer(e){this.playerSlots.push(e)}setTimeJoined(e){this.timeJoined=e}isFull(){return this.playerSlots.length==this.playerSlots.length}isEmpty(){return 0===this.playerSlots.length}createLobbyElement(){const e=document.getElementById("lobbyContainer");if(e){const t=document.createElement("div");t.className="lobby",t.id=`lobby-${this.id}`;const s=document.createElement("div");s.className="lobby-id",s.textContent=`id:${this.id}`;const i=document.createElement("div");i.className="class-id",i.id=`class-id-${this.id}`,i.textContent=`class:${this.classId}`,i.onclick=()=>this.incrementClassId();const n=document.createElement("div");n.className="queue-time",n.id=`queue-time-${this.id}`,n.style.display="none";const a=document.createElement("div");a.className="remove-btn toggle-ready-btn",a.textContent="âœ“",a.onclick=()=>this.toggleLobbyReady();const l=document.createElement("div");l.className="remove-btn",l.textContent="X",l.onclick=()=>this.onDelete(this.id);const o=document.createElement("div");o.className="player-slots";for(let e=0;e<3;e++){const t=document.createElement("div");t.className="player-slot empty",t.id=`lobby-${this.id}-slot-${e}`,t.onclick=()=>this.handleSlotClick(e),o.appendChild(t)}t.appendChild(s),t.appendChild(i),t.appendChild(n),t.appendChild(a),t.appendChild(l),t.appendChild(o),e.appendChild(t)}}handleSlotClick(e){if(null===this.playerSlots[e]){const t=new s;this.playerSlots[e]=t}else{const t=this.playerSlots[e];t&&(t.ready=!t.ready)}this.updateDisplay(),this.checkAndFireReadyStatusChange()}updateDisplay(){for(let s=0;s<this.playerSlots.length;s++){const e=document.getElementById(`lobby-${this.id}-slot-${s}`);if(e){const t=this.playerSlots[s];if(t){const i=e.querySelector("span")||document.createElement("span");if(i.textContent=t.name,e.className="player-slot filled "+(t.ready?"ready":"not-ready"),e.querySelector("span")||e.appendChild(i),!e.querySelector(".remove-btn")){const t=document.createElement("div");t.textContent="X",t.className="remove-btn",t.onclick=e=>{e.stopPropagation(),this.removePlayer(s)},e.appendChild(t)}}else e.innerHTML="",e.className="player-slot empty"}}const e=document.getElementById(`lobby-${this.id}`),t=document.getElementById(`queue-time-${this.id}`);if(e&&t&&(this.allReady?(e.className="lobby lobby-ready",t.style.display="block"):(e.className="lobby",t.style.display="none")),this.timeJoined>0){const e=document.getElementById(`queue-time-${this.id}`);if(e){const t=Date.now()-this.timeJoined,s=Math.floor(t/6e4),i=Math.floor(t%6e4/1e3);e.textContent=`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}}else{const e=document.getElementById(`queue-time-${this.id}`);e&&(e.textContent="pending...")}}removePlayer(e){this.playerSlots[e]=null,this.setAllReady(!1)}toggleLobbyReady(){const e=this.playerSlots.every(e=>null===e||e.ready);this.setAllReady(!e)}setAllReady(e){this.playerSlots.forEach(t=>{t&&(t.ready=e)}),this.updateDisplay(),this.checkAndFireReadyStatusChange()}incrementClassId(){this.classId=(this.classId+1)%3,this.updateClassIdDisplay()}updateClassIdDisplay(){const e=document.getElementById(`class-id-${this.id}`);e&&(e.textContent=`class:${this.classId}`)}destroy(){const e=document.getElementById(`lobby-${this.id}`);e&&e.remove()}}class n{static runMatchAlgorithm(e){if(0===e.length)return null;const t=this.findSixPlayerMatch(e);if(t)return t;{const t=e.filter(e=>e.aiEligible);if(t.length>0){const e=this.findSixPlayerMatch(t);if(e)return e;{const e=Date.now();if(t.filter(t=>e-t.timeJoined>=r.AI_ELIGIBLE_TIME_THRESHOLD).length>0){const e=this.findAIAssistedMatch(t);if(e)return e}}}}return null}static findSixPlayerMatch(e){const t=this.findCombination(e,6,0,[]);if(t){const e=this.splitIntoTeams(t);if(e)return e}return null}static findCombination(e,t,s,i){const n=i.reduce((e,t)=>e+t.playerCount,0);if(n===t)return i;if(n>t||s>=e.length)return null;return this.findCombination(e,t,s+1,[...i,e[s]])||this.findCombination(e,t,s+1,i)}static splitIntoTeams(e){const t=this.findTeamCombination(e,3,0,[]);if(t){const s=e.filter(e=>!t.includes(e));if(3===s.reduce((e,t)=>e+t.playerCount,0))return{team1:t,team2:s}}return null}static findTeamCombination(e,t,s,i){const n=i.reduce((e,t)=>e+t.playerCount,0);if(n===t)return i;if(n>t||s>=e.length)return null;return this.findTeamCombination(e,t,s+1,[...i,e[s]])||this.findTeamCombination(e,t,s+1,i)}static findAIAssistedMatch(e){for(let t=e.length;t>=1;t--){const s=this.getCombinations(e,t);for(const e of s){const t=6-e.reduce((e,t)=>e+t.playerCount,0);if(t>=0&&t<=6){const s=this.splitIntoTeamsWithAI(e,t);if(s)return{...s,aiPlayers:t}}}}return null}static splitIntoTeamsWithAI(e,t){if(0===t)return this.splitIntoTeams(e);for(let s=0;s<=e.length;s++){const i=this.getCombinations(e,s);for(const s of i){const i=e.filter(e=>!s.includes(e)),n=s.reduce((e,t)=>e+t.playerCount,0),a=i.reduce((e,t)=>e+t.playerCount,0),l=3-n,o=3-a;if(l>=0&&o>=0&&l+o===t&&n<=3&&a<=3)return{team1:s,team2:i}}}return null}static getCombinations(e,t){if(0===t)return[[]];if(0===e.length)return[];const[s,...i]=e;return[...this.getCombinations(i,t-1).map(e=>[s,...e]),...this.getCombinations(i,t)]}}class a{static runMatchAlgorithm(e){if(0===e.length)return null;const t=this.findSixPlayerMatch(e);if(t)return t;{const t=e.filter(e=>e.aiEligible);if(t.length>0){const e=this.findSixPlayerMatch(t);if(e)return e;{const e=Date.now();if(t.filter(t=>e-t.timeJoined>=r.AI_ELIGIBLE_TIME_THRESHOLD).length>0){const e=this.findAIAssistedMatch(t);if(e)return e}}}}return null}static findSixPlayerMatch(e){const t=this.findAllSixPlayerCombinations(e);for(const s of t){const e=this.splitIntoTeams(s);if(e)return e}return null}static findAllSixPlayerCombinations(e){const t=[];return this.findAllCombinations(e,6,0,[],t),t}static findAllCombinations(e,t,s,i,n){const a=i.reduce((e,t)=>e+t.playerCount,0);a!==t?a>t||s>=e.length||(this.findAllCombinations(e,t,s+1,[...i,e[s]],n),this.findAllCombinations(e,t,s+1,i,n)):n.push([...i])}static splitIntoTeams(e){return this.findClassCompatibleTeams(e)}static findClassCompatibleTeams(e){for(let t=0;t<=e.length;t++){const s=this.getCombinations(e,t);for(const t of s)if(3===t.reduce((e,t)=>e+t.playerCount,0)){const s=e.filter(e=>!t.includes(e));if(3===s.reduce((e,t)=>e+t.playerCount,0)){const e=this.isTeamClassCompatible(t),i=this.isTeamClassCompatible(s);if(e&&i)return{team1:t,team2:s}}}}return null}static isTeamClassCompatible(e){if(e.length<=1)return!0;const t=e[0].classId;return e.every(e=>e.classId===t)}static findAIAssistedMatch(e){for(let t=e.length;t>=1;t--){const s=this.getCombinations(e,t);for(const e of s){const t=6-e.reduce((e,t)=>e+t.playerCount,0);if(t>=0&&t<=6){const s=this.splitIntoTeamsWithAI(e,t);if(s)return{...s,aiPlayers:t}}}}return null}static splitIntoTeamsWithAI(e,t){if(0===t)return this.splitIntoTeams(e);for(let s=0;s<=e.length;s++){const i=this.getCombinations(e,s);for(const s of i){const i=e.filter(e=>!s.includes(e)),n=s.reduce((e,t)=>e+t.playerCount,0),a=i.reduce((e,t)=>e+t.playerCount,0),l=3-n,o=3-a;if(l>=0&&o>=0&&l+o===t&&n<=3&&a<=3&&this.isTeamClassCompatible(s)&&this.isTeamClassCompatible(i))return{team1:s,team2:i}}}return null}static getCombinations(e,t){if(0===t)return[[]];if(0===e.length)return[];const[s,...i]=e;return[...this.getCombinations(i,t-1).map(e=>[s,...e]),...this.getCombinations(i,t)]}}const l=class e{constructor(e){t(this,"queuedLobbies"),t(this,"onLobbyDelete"),this.queuedLobbies=[],this.onLobbyDelete=e,this.setupEventListeners()}setupEventListeners(){document.addEventListener("lobbyReadyStatusChanged",e=>{const t=e,{lobby:s,allReady:i}=t.detail;i&&!this.isLobbyQueued(s)?this.addLobby(s):!i&&this.isLobbyQueued(s)&&this.removeLobby(s)})}isLobbyQueued(e){return this.queuedLobbies.includes(e)}addLobby(e){this.queuedLobbies.push(e),e.setTimeJoined(Date.now())}removeLobby(e){e.setTimeJoined(0),this.queuedLobbies.splice(this.queuedLobbies.indexOf(e),1)}tick(){this.updateAiEligibility(),this.runMatchAlgorithm(),this.updateLobbyQueueDisplay()}updateAiEligibility(){const t=Date.now();this.queuedLobbies.forEach(s=>{!s.aiEligible&&s.timeJoined>0&&t-s.timeJoined>=e.AI_ELIGIBLE_TIME&&(s.aiEligible=!0)})}updateLobbyQueueDisplay(){const t=document.getElementById("matchQueueList");t&&(t.innerHTML="",this.queuedLobbies.forEach(s=>{const i=document.createElement("div"),n=Date.now()-s.timeJoined,a=Math.floor(n/6e4),l=Math.floor(n%6e4/1e3);let o="";n>=e.AI_ELIGIBLE_TIME_THRESHOLD?(o="[AI-READY]",i.className="queue-lobby queue-lobby-ai-ready"):s.aiEligible?(o="[AI-ELIGIBLE]",i.className="queue-lobby queue-lobby-ai-eligible"):(o="[NO AI]",i.className="queue-lobby queue-lobby-normal");const r=document.createElement("div");r.className="queue-lobby-info",r.textContent="Lobby:"+s.id.toString()+" - P:"+s.playerCount+" - inQ:",r.textContent+=a.toString().padStart(2,"0")+":"+l.toString().padStart(2,"0");const d=document.createElement("div");d.className="queue-lobby-status",d.textContent=o,i.appendChild(r),i.appendChild(d),t.appendChild(i)}))}runMatchAlgorithm(){if(0===this.queuedLobbies.length)return;const t=performance.now();let s=null;s=e.ALLOW_TEAM_CLASS_MIX?n.runMatchAlgorithm(this.queuedLobbies):a.runMatchAlgorithm(this.queuedLobbies),s&&this.createMatch(s.team1,s.team2,s.aiPlayers||0),(performance.now()-t).toFixed(2)}createMatch(e,t,s=0){const i=[...e,...t];this.displayMatchResult(e,t,s),i.forEach(e=>{const t=this.queuedLobbies.indexOf(e);t>-1&&(this.queuedLobbies.splice(t,1),e.setTimeJoined(0)),e.id>=0&&this.onLobbyDelete(e.id)})}displayMatchResult(e,t,s=0){const i=document.getElementById("matchResultsList");if(i){const n=document.createElement("div");n.className="match-result";const a=document.createElement("div");a.className="match-teams";const l=this.createTeamElement(e,"team-blue",s),o=this.createTeamElement(t,"team-red",s);a.appendChild(l),a.appendChild(o),n.appendChild(a),i.insertBefore(n,i.firstChild)}}createTeamElement(e,t,s){const i=document.createElement("div");if(i.className=`team-box ${t}`,e.forEach(e=>{const t=this.createLobbyElement(e);i.appendChild(t)}),s>0){const t=3-e.reduce((e,t)=>e+t.playerCount,0);for(let e=0;e<t;e++){const e=this.createAIPlayerElement();i.appendChild(e)}}return i}createLobbyElement(e){const t=document.createElement("div");t.className="match-lobby";const s=e.playerSlots.filter(e=>null!==e).map(e=>e.name).join(", "),i=document.createElement("span");i.textContent=s;const n=document.createElement("span");return n.className="match-lobby-class",n.textContent=`c${e.classId}`,t.appendChild(i),t.appendChild(n),t}createAIPlayerElement(){const e=document.createElement("div");return e.className="match-lobby ai-player",e.textContent=`AI-Bot${Math.floor(1e3*Math.random())}`,e}};t(l,"AI_ELIGIBLE_TIME",15e3),t(l,"AI_ELIGIBLE_TIME_THRESHOLD",35e3),t(l,"ALLOW_TEAM_CLASS_MIX",!0);let o,r=l;class d{constructor(){t(this,"isPaused",!1),t(this,"removeTopBarHandler"),t(this,"lobbies",new Map),t(this,"nextLobbyId",0),t(this,"matcher",new r(e=>this.deleteLobby(e))),this.init()}init(){this.setupTopBarEvents(),this.setupUI(),this.startHeartbeat()}setupUI(){const e=document.getElementById("createLobbyBtn");e&&e.addEventListener("click",()=>this.addLobby()),this.setupSettingsPanel()}setupSettingsPanel(){const e=document.getElementById("classMixToggle"),t=document.getElementById("classMixStatus");e&&t&&(this.updateClassMixDisplay(),e.addEventListener("click",()=>{r.ALLOW_TEAM_CLASS_MIX=!r.ALLOW_TEAM_CLASS_MIX,this.updateClassMixDisplay()}));const s=document.getElementById("aiEligibleTimeInput");s&&(s.value=r.AI_ELIGIBLE_TIME.toString(),s.addEventListener("input",()=>{const e=parseInt(s.value);!isNaN(e)&&e>0&&(r.AI_ELIGIBLE_TIME=e)}));const i=document.getElementById("aiReadyTimeInput");i&&(i.value=r.AI_ELIGIBLE_TIME_THRESHOLD.toString(),i.addEventListener("input",()=>{const e=parseInt(i.value);!isNaN(e)&&e>0&&(r.AI_ELIGIBLE_TIME_THRESHOLD=e)}))}updateClassMixDisplay(){const e=document.getElementById("classMixToggle"),t=document.getElementById("classMixStatus");e&&t&&(r.ALLOW_TEAM_CLASS_MIX?(e.classList.add("enabled"),t.textContent="ENABLED"):(e.classList.remove("enabled"),t.textContent="DISABLED"))}addLobby(){const e=this.nextLobbyId++,t=new i(e,e=>this.deleteLobby(e));this.lobbies.set(e,t)}deleteLobby(e){const t=this.lobbies.get(e);t&&(this.matcher.isLobbyQueued(t)&&this.matcher.removeLobby(t),t.destroy(),this.lobbies.delete(e))}setupTopBarEvents(){const e=e=>{"pause"===e.type?this.togglePause():"menu"===e.type&&this.returnToMainMenu()};document.addEventListener("pause",e),document.addEventListener("menu",e),this.removeTopBarHandler=()=>{document.removeEventListener("pause",e),document.removeEventListener("menu",e)}}togglePause(){this.isPaused=!this.isPaused}destroy(){this.removeTopBarHandler&&this.removeTopBarHandler()}returnToMainMenu(){this.destroy(),window.location.href="/arcade/"}startHeartbeat(){setInterval(()=>{this.updateLobbies()},1e3)}updateLobbies(){this.lobbies.forEach(e=>{e.updateDisplay()}),this.matcher.tick()}}window.returnToMainMenu=()=>null==o?void 0:o.returnToMainMenu(),window.togglePause=()=>null==o?void 0:o.togglePause(),document.addEventListener("DOMContentLoaded",function(){o=new d});
