var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);import"./main-DwgLx9N3.js";import{C as i,b as s,S as r,R as n,c as h,d as a,G as o,e as c,A as p}from"./HTMLText-COKViVEb.js";class d{constructor(t,i,s,r,n){e(this,"sprite"),e(this,"id"),e(this,"originX"),e(this,"originY"),e(this,"dragOffset",{x:0,y:0}),e(this,"hole",null),e(this,"inPlay",!1),e(this,"gameWidth"),e(this,"gameHeight"),e(this,"app"),this.sprite=t,this.id=i,this.originX=t.position.x,this.originY=t.position.y,this.gameWidth=s,this.gameHeight=r,this.app=n,this.makeDraggable(),this.inPlay=!0}makeDraggable(){this.sprite.eventMode="static",this.sprite.cursor="pointer",this.sprite.on("pointerdown",t=>{if(!this.inPlay)return;const e=t.getLocalPosition(this.sprite.parent);this.dragOffset.x=e.x-this.sprite.position.x,this.dragOffset.y=e.y-this.sprite.position.y,this.sprite.parent.addChild(this.sprite);const i=new CustomEvent("startChunkDrag",{detail:{chunk:this,event:t}});document.dispatchEvent(i)})}checkSnapToHole(){Math.sqrt(Math.pow(this.sprite.position.x-this.originX,2)+Math.pow(this.sprite.position.y-this.originY,2))<u.snapThreshold&&(this.sprite.position.x=this.originX,this.sprite.position.y=this.originY,this.correctlyPlaced())}onDrop(){this.sprite.position.x<0&&(this.sprite.position.x=0),this.sprite.position.x>this.gameWidth-this.sprite.width&&(this.sprite.position.x=this.gameWidth-this.sprite.width),this.sprite.position.y<0&&(this.sprite.position.y=0),this.sprite.position.y>this.gameHeight-this.sprite.height&&(this.sprite.position.y=this.gameHeight-this.sprite.height),this.checkSnapToHole()}correctlyPlaced(){this.sprite.alpha=1,this.inPlay=!1,this.sprite.eventMode="none",this.sprite.cursor="default",this.sprite.parent.setChildIndex(this.sprite,0);const t=new c;this.sprite.filters=[t];let e=0;const i=s=>{e+=s;const r=Math.min(e/50,1);let n;if(r<.25){const t=r/.25;n=2+t*t*3}else if(r<.875){const t=(r-.625)/.25;n=3-2*(1-(1-t)*(1-t))}else n=1;t.brightness(n,!1),r>=1&&(this.sprite.filters=[],this.app.ticker.remove(i))};this.app.ticker.add(i)}}class g{constructor(t,i,s){e(this,"id"),e(this,"chunk"),e(this,"graphics"),this.id=i,this.chunk=s,this.graphics=t}}class l{constructor(t,s,r,n){e(this,"app"),e(this,"gameContainer"),e(this,"currentStickerSprite",null),e(this,"gameWidth"),e(this,"gameHeight"),e(this,"holeContainer"),e(this,"chunkContainer"),e(this,"chunks",{}),e(this,"holes",{}),e(this,"activeChunk",null),this.app=t,this.gameContainer=s,this.gameWidth=r,this.gameHeight=n,this.holeContainer=new i,this.chunkContainer=new i,this.setupStickerMakerEvents()}setupStickerMakerEvents(){document.addEventListener("startChunkDrag",t=>{const e=t,{chunk:i,event:s}=e.detail;this.handleStartDrag(i,s)})}handleStartDrag(t,e){this.activeChunk||(this.activeChunk=t)}async createSticker(t){performance.now();const e=await s.load(t);this.currentStickerSprite=new r(e);const i=.9*this.gameWidth,n=.9*this.gameHeight;if(this.currentStickerSprite.width>i||this.currentStickerSprite.height>n){const t=i/this.currentStickerSprite.width,e=n/this.currentStickerSprite.height,s=Math.min(t,e);this.currentStickerSprite.scale.set(s)}this.currentStickerSprite.anchor.set(.5,.5),this.currentStickerSprite.position.set(this.gameWidth/2,this.gameHeight/2),this.gameContainer.addChild(this.currentStickerSprite),this.gameContainer.addChild(this.holeContainer),this.gameContainer.addChild(this.chunkContainer),this.cutIntoTrianglesAndSquares(e),performance.now(),this.shuffleChunks()}cutIntoTrianglesAndSquares(t){const e=n.create({width:t.width,height:t.height}),i=new r(t);this.app.renderer.render(i,{renderTexture:e});const s=this.app.renderer.extract.canvas(e),h=s.getContext("2d").getImageData(0,0,s.width,s.height).data,a=u.gideSize,o=t.width/a,c=t.height/a;for(let r=0;r<a;r++)for(let e=0;e<a;e++){const i=Math.round(e*o),n=Math.round(r*c),a=Math.round((e+1)*o),p=Math.round((r+1)*c);let d=!1,g=0;const l=(a-i)*(p-n);for(let t=n;t<p;t++)for(let e=i;e<a;e++)h[4*(t*s.width+e)+3]>128&&(d=!0,g++);d&&g/l>=u.visiblePercentage&&(Math.random()>.5?this.createDraggableSquareFromTexture(i,n,a,p,t):Math.random()>.5?(this.createDraggableTriangleFromTexture(i,n,a,n,i,p,t),this.createDraggableTriangleFromTexture(a,n,a,p,i,p,t)):(this.createDraggableTriangleFromTexture(i,n,a,n,a,p,t),this.createDraggableTriangleFromTexture(i,n,a,p,i,p,t)))}e.destroy(!0)}createDraggableSquareFromTexture(t,e,i,s,n){if(!this.currentStickerSprite)throw new Error("Sticker sprite not found");const o=new h(t,e,i-t,s-e),c=new a(n.baseTexture,o),p=new r(c),g=this.currentStickerSprite.position.x-this.currentStickerSprite.width/2,l=this.currentStickerSprite.position.y-this.currentStickerSprite.height/2;p.position.set(g+t*this.currentStickerSprite.scale.x,l+e*this.currentStickerSprite.scale.y),p.scale.set(this.currentStickerSprite.scale.x,this.currentStickerSprite.scale.y);const u=new d(p,`chunk_${Object.keys(this.chunks).length+1}`,this.gameWidth,this.gameHeight,this.app);this.chunks[u.id]=u,this.chunkContainer.addChild(p),this.paintHoleFromSprite(u,i-t,s-e)}createDraggableTriangleFromTexture(t,e,i,s,r,n,c){if(!this.currentStickerSprite)throw new Error("Sticker sprite not found.");const p=Math.min(t,i,r),g=Math.min(e,s,n),l=Math.max(t,i,r),u=Math.max(e,s,n),m=new h(p,g,l-p,u-g),k=new a(c.baseTexture,m),w=new o;w.beginTextureFill({texture:k}),w.moveTo(t-p,e-g),w.lineTo(i-p,s-g),w.lineTo(r-p,n-g),w.lineTo(t-p,e-g),w.endFill();const S=this.currentStickerSprite.position.x-this.currentStickerSprite.width/2,v=this.currentStickerSprite.position.y-this.currentStickerSprite.height/2;w.position.set(S+p*this.currentStickerSprite.scale.x,v+g*this.currentStickerSprite.scale.y),w.scale.set(this.currentStickerSprite.scale.x,this.currentStickerSprite.scale.y);const f=new d(w,`chunk_${Object.keys(this.chunks).length+1}`,this.gameWidth,this.gameHeight,this.app);this.chunks[f.id]=f,this.chunkContainer.addChild(w),this.paintHoleFromSprite(f,l-p,u-g)}paintHoleFromSprite(t,e,i){if(!this.currentStickerSprite)throw new Error("Sticker sprite not found");let s;s=t.sprite instanceof r?new r(t.sprite.texture):t.sprite.clone(),s.position.set(0,0),s.scale.set(1,1);const h=n.create({width:e,height:i});this.app.renderer.render(s,{renderTexture:h});const a=this.app.renderer.extract.canvas(h).getContext("2d").getImageData(0,0,e,i).data,c=Math.floor(156*Math.random())+100<<16|Math.floor(156*Math.random())+100<<8|Math.floor(156*Math.random())+100,p=Math.floor(100*Math.random())+100,d=p<<16|p<<8|p,l=new o;for(let r=0;r<i;r++)for(let i=0;i<e;i++){const s=a[4*(r*e+i)+3];if(s>0){const e=s>128?c:d;l.beginFill(e),l.drawRect(t.sprite.position.x+i*t.sprite.scale.x,t.sprite.position.y+r*t.sprite.scale.y,1,1),l.endFill()}}this.holeContainer.addChild(l);const u=new g(l,t.id,t);this.holes[t.id]=u,t.hole=u,h.destroy(!0)}shuffleChunks(){if(!this.currentStickerSprite)return;const t=.1*this.gameWidth;for(const e of Object.values(this.chunks)){const i=Math.random()>.5;e.sprite.position.x=i?Math.random()*t:this.gameWidth-t+Math.random()*t,e.sprite.position.y=Math.random()*this.gameHeight,e.sprite.position.x<0&&(e.sprite.position.x=0),e.sprite.position.x>this.gameWidth-e.sprite.width&&(e.sprite.position.x=this.gameWidth-e.sprite.width),e.sprite.position.y<0&&(e.sprite.position.y=0),e.sprite.position.y>this.gameHeight-e.sprite.height&&(e.sprite.position.y=this.gameHeight-e.sprite.height)}}onMove(t){if(this.activeChunk){const e=t.getLocalPosition(this.activeChunk.sprite.parent);this.activeChunk.sprite.position.x=e.x-this.activeChunk.dragOffset.x,this.activeChunk.sprite.position.y=e.y-this.activeChunk.dragOffset.y}}onUp(){this.activeChunk&&(this.activeChunk.onDrop(),this.activeChunk=null)}}const u={gideSize:5,snapThreshold:15,visiblePercentage:.16},m=()=>({gameWidth:window.innerWidth,gameHeight:window.innerHeight-60,topBarHeight:60,scale:1});class k{constructor(t){e(this,"app"),e(this,"gameContainer"),e(this,"stickerMaker"),e(this,"removeTopBarHandler"),e(this,"gameDimensions"),this.app=t,this.gameContainer=new i,this.gameDimensions=m(),this.stickerMaker=new l(this.app,this.gameContainer,this.gameDimensions.gameWidth,this.gameDimensions.gameHeight),this.app.stage.addChild(this.gameContainer),this.setupGlobalPointerEvents()}async init(){this.createBackground(),await this.stickerMaker.createSticker("/arcade/assets/stickers/lion.png"),this.setupTopBarEvents()}createBackground(){const t=new o;t.beginFill(16777215),t.drawRect(0,0,this.gameDimensions.gameWidth,this.gameDimensions.gameHeight),t.endFill(),this.gameContainer.addChild(t)}setupTopBarEvents(){const t=t=>{"pause"===t.type?this.togglePause():"menu"===t.type&&this.returnToMainMenu()};document.addEventListener("pause",t),document.addEventListener("menu",t),this.removeTopBarHandler=()=>{document.removeEventListener("pause",t),document.removeEventListener("menu",t)}}update(t){}togglePause(){}destroy(){this.removeTopBarHandler&&this.removeTopBarHandler(),this.app.stage.removeChild(this.gameContainer),this.gameContainer.destroy({children:!0})}returnToMainMenu(){window.location.href="/arcade/"}setupGlobalPointerEvents(){this.app.stage.eventMode="static",this.app.stage.on("pointermove",t=>{this.stickerMaker.onMove(t)}),this.app.stage.on("pointerup",()=>{this.stickerMaker.onUp()}),this.app.stage.on("pointerupoutside",()=>{this.stickerMaker.onUp()}),this.app.view.oncontextmenu=t=>t.preventDefault()}}function w(){const t=document.querySelector("canvas");if(t){const e=m();t.style.width=`${e.gameWidth}px`,t.style.height=`${e.gameHeight}px`}}window.isInit=!1,window.addEventListener("load",async function(){if(window.isInit)return;window.isInit=!0;const t=m(),e=new p({width:t.gameWidth,height:t.gameHeight,backgroundColor:16777215,antialias:!0,resolution:window.devicePixelRatio||1}),i=document.getElementById("gameContainer");i&&i.appendChild(e.view),w();const s=new k(e);await s.init(),e.ticker.add(t=>{s.update(t)}),window.addEventListener("resize",()=>{w()}),window.restartGame=()=>{},window.returnToMainMenu=()=>{s.returnToMainMenu()},window.resumeGame=()=>{},window.togglePause=()=>{s.togglePause()}});
