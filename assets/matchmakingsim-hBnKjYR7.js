var e=Object.defineProperty,t=(t,s,n)=>((t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n)(t,"symbol"!=typeof s?s+"":s,n);import"./main-Dacpvxy9.js";import"./game-top-bar-D2G5Ym00.js";class s{constructor(){t(this,"name"),t(this,"ready"),this.name="Player"+Math.floor(1e3*Math.random()),this.ready=!1}}class n{constructor(e,s,n){t(this,"id"),t(this,"playerSlots"),t(this,"timeJoined"),t(this,"aiEligible"),t(this,"classId"),t(this,"onDelete"),t(this,"previousAllReady",!1),this.id=e,this.playerSlots=[null,null,null],this.timeJoined=0,this.aiEligible=!1,this.classId=s,this.onDelete=n,this.createLobbyElement()}get allReady(){return this.playerSlots.some(e=>null!==e)&&this.playerSlots.every(e=>null===e||e.ready)}checkAndFireReadyStatusChange(){const e=this.allReady;if(e!==this.previousAllReady){this.previousAllReady=e;const t=new CustomEvent("lobbyReadyStatusChanged",{detail:{lobby:this,allReady:e}});document.dispatchEvent(t)}}get playerCount(){return this.playerSlots.filter(e=>null!==e).length}addPlayer(e){const t=this.playerSlots.findIndex(e=>null===e);-1!==t&&(this.playerSlots[t]=e,this.updateDisplay(),this.checkAndFireReadyStatusChange())}setTimeJoined(e){this.timeJoined=e}isFull(){return this.playerSlots.length==this.playerSlots.length}isEmpty(){return 0===this.playerSlots.length}createLobbyElement(){const e=document.getElementById("lobbyContainer");if(e){const t=document.createElement("div");t.className="lobby",t.id=`lobby-${this.id}`;const s=document.createElement("div");s.className="lobby-id",s.textContent=`id:${this.id}`;const n=document.createElement("div");n.className="class-id",n.id=`class-id-${this.id}`,n.textContent=`class:${this.classId}`,n.onclick=()=>this.incrementClassId();const i=document.createElement("div");i.className="queue-time",i.id=`queue-time-${this.id}`,i.style.display="none";const a=document.createElement("div");a.className="remove-btn toggle-ready-btn",a.textContent="âœ“",a.onclick=()=>this.toggleLobbyReady();const l=document.createElement("div");l.className="remove-btn",l.textContent="X",l.onclick=()=>this.onDelete(this.id);const o=document.createElement("div");o.className="player-slots";for(let e=0;e<3;e++){const t=document.createElement("div");t.className="player-slot empty",t.id=`lobby-${this.id}-slot-${e}`,t.onclick=()=>this.handleSlotClick(e),o.appendChild(t)}t.appendChild(s),t.appendChild(n),t.appendChild(i),t.appendChild(a),t.appendChild(l),t.appendChild(o),e.appendChild(t)}}handleSlotClick(e){if(null===this.playerSlots[e]){const t=new s;this.playerSlots[e]=t}else{const t=this.playerSlots[e];t&&(t.ready=!t.ready)}this.updateDisplay(),this.checkAndFireReadyStatusChange()}updateDisplay(){for(let s=0;s<this.playerSlots.length;s++){const e=document.getElementById(`lobby-${this.id}-slot-${s}`);if(e){const t=this.playerSlots[s];if(t){const n=e.querySelector("span")||document.createElement("span");if(n.textContent=t.name,e.className="player-slot filled "+(t.ready?"ready":"not-ready"),e.querySelector("span")||e.appendChild(n),!e.querySelector(".remove-btn")){const t=document.createElement("div");t.textContent="X",t.className="remove-btn",t.onclick=e=>{e.stopPropagation(),this.removePlayer(s)},e.appendChild(t)}}else e.innerHTML="",e.className="player-slot empty"}}const e=document.getElementById(`lobby-${this.id}`),t=document.getElementById(`queue-time-${this.id}`);if(e&&t&&(this.allReady?(e.className="lobby lobby-ready",t.style.display="block"):(e.className="lobby",t.style.display="none")),this.timeJoined>0){const e=document.getElementById(`queue-time-${this.id}`);if(e){const t=Date.now()-this.timeJoined,s=Math.floor(t/6e4),n=Math.floor(t%6e4/1e3);e.textContent=`${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}}else{const e=document.getElementById(`queue-time-${this.id}`);e&&(e.textContent="pending...")}}removePlayer(e){this.playerSlots[e]=null,this.setAllReady(!1)}toggleLobbyReady(){const e=this.playerSlots.every(e=>null===e||e.ready);this.setAllReady(!e)}setAllReady(e){this.playerSlots.forEach(t=>{t&&(t.ready=e)}),this.updateDisplay(),this.checkAndFireReadyStatusChange()}incrementClassId(){this.classId=(this.classId+1)%3,this.updateClassIdDisplay()}updateClassIdDisplay(){const e=document.getElementById(`class-id-${this.id}`);e&&(e.textContent=`class:${this.classId}`)}destroy(){const e=document.getElementById(`lobby-${this.id}`);e&&e.remove()}}class i{static runMatchAlgorithm(e){if(0===e.length)return null;const t=this.findSixPlayerMatchGreedy(e);if(t)return t;const s=e.filter(e=>e.aiEligible);if(s.length>0){const e=this.findSixPlayerMatchGreedy(s);if(e)return e;{const e=Date.now();if(s.filter(t=>e-t.timeJoined>=r.AI_ELIGIBLE_TIME_THRESHOLD).length>0){const e=this.findAIAssistedMatchGreedy(s);if(e)return e}}}return null}static findSixPlayerMatchGreedy(e){const t=new Array(7).fill(null).map(()=>[]);t[0]=[];for(const s of e){const e=s.playerCount;for(let n=6;n>=e;n--)if(null!==t[n-e]&&(t[n]=[...t[n-e],s],6===n)){const e=this.splitIntoTeamsGreedy(t[n]);if(e)return e}}return null}static splitIntoTeamsGreedy(e){const t=[],s=[];let n=0;for(const a of e){const e=a.playerCount;n+e<=3?(t.push(a),n+=e):s.push(a)}const i=s.reduce((e,t)=>e+t.playerCount,0);return 3===n&&3===i?{team1:t,team2:s}:null}static findAIAssistedMatchGreedy(e){for(let t=Math.min(6,e.reduce((e,t)=>e+t.playerCount,0));t>=1;t--){const s=6-t;if(s>=0&&s<=6){const n=this.findExactPlayerCountGreedy(e,t);if(n){const e=this.splitIntoTeamsWithAIGreedy(n,s);if(e)return{...e,aiPlayers:s}}}}return null}static findExactPlayerCountGreedy(e,t){const s=new Array(t+1).fill(null).map(()=>null);s[0]=[];for(const n of e){const e=n.playerCount;for(let i=t;i>=e;i--)if(null!==s[i-e]&&(s[i]=[...s[i-e],n],i===t))return s[i]}return null}static splitIntoTeamsWithAIGreedy(e,t){if(0===t)return this.splitIntoTeamsGreedy(e);const s=[],n=[];let i=0,a=0;for(const r of e){const e=r.playerCount;i+e<=3&&(i<=a||a+e>3)?(s.push(r),i+=e):a+e<=3&&(n.push(r),a+=e)}const l=3-i,o=3-a;return l>=0&&o>=0&&l+o===t&&i<=3&&a<=3?{team1:s,team2:n}:null}}class a{static runMatchAlgorithm(e){if(0===e.length)return null;const t=this.findSixPlayerMatchGreedy(e);if(t)return t;const s=e.filter(e=>e.aiEligible);if(s.length>0){const e=this.findSixPlayerMatchGreedy(s);if(e)return e;{const e=Date.now();if(s.filter(t=>e-t.timeJoined>=r.AI_ELIGIBLE_TIME_THRESHOLD).length>0){const e=this.findAIAssistedMatchGreedy(s);if(e)return e}}}return null}static findSixPlayerMatchGreedy(e){const t=new Map;for(const n of e)t.has(n.classId)||t.set(n.classId,[]),t.get(n.classId).push(n);for(const n of t.values()){const e=this.findSixPlayerSameClassGreedy(n);if(e)return e}const s=Array.from(t.keys());for(let n=0;n<s.length;n++)for(let e=n+1;e<s.length;e++){const i=t.get(s[n]),a=t.get(s[e]),l=this.findSixPlayerCrossClassGreedy(i,a);if(l)return l}return null}static findSixPlayerSameClassGreedy(e){const t=new Array(7).fill(null).map(()=>null);t[0]=[];for(const s of e){const e=s.playerCount;for(let n=6;n>=e;n--)if(null!==t[n-e]&&(t[n]=[...t[n-e],s],6===n&&null!==t[n])){const e=this.splitIntoTeamsSameClass(t[n]);if(e)return e}}return null}static findSixPlayerCrossClassGreedy(e,t){const s=this.findExactPlayerCountGreedy(e,3);if(s){const e=this.findExactPlayerCountGreedy(t,3);if(e)return{team1:s,team2:e}}const n=this.findExactPlayerCountGreedy(t,3);if(n){const t=this.findExactPlayerCountGreedy(e,3);if(t)return{team1:n,team2:t}}return null}static splitIntoTeamsSameClass(e){const t=[],s=[];let n=0;for(const a of e){const e=a.playerCount;n+e<=3?(t.push(a),n+=e):s.push(a)}const i=s.reduce((e,t)=>e+t.playerCount,0);return 3===n&&3===i?{team1:t,team2:s}:null}static findExactPlayerCountGreedy(e,t){const s=new Array(t+1).fill(null).map(()=>null);s[0]=[];for(const n of e){const e=n.playerCount;for(let i=t;i>=e;i--)if(null!==s[i-e]&&(s[i]=[...s[i-e],n],i===t))return s[i]}return null}static findAIAssistedMatchGreedy(e){const t=new Map;for(const s of e)t.has(s.classId)||t.set(s.classId,[]),t.get(s.classId).push(s);for(let s=Math.min(6,e.reduce((e,t)=>e+t.playerCount,0));s>=1;s--){const e=6-s;if(e>=0&&e<=6){for(const i of t.values()){const t=this.findExactPlayerCountGreedy(i,s);if(t){const s=this.splitIntoTeamsWithAIGreedy(t,e);if(s)return{...s,aiPlayers:e}}}const n=Array.from(t.keys());for(let i=0;i<n.length;i++)for(let a=i+1;a<n.length;a++){const l=t.get(n[i]),o=t.get(n[a]);for(let t=1;t<s;t++){const n=s-t,i=this.findExactPlayerCountGreedy(l,t),a=this.findExactPlayerCountGreedy(o,n);if(i&&a){const t=[...i,...a],s=this.splitIntoTeamsWithAIGreedyClassCheck(t,e);if(s)return{...s,aiPlayers:e}}}}}}return null}static splitIntoTeamsWithAIGreedy(e,t){if(0===t)return this.splitIntoTeamsSameClass(e);const s=[],n=[];let i=0,a=0;for(const r of e){const e=r.playerCount;i+e<=3&&(i<=a||a+e>3)?(s.push(r),i+=e):a+e<=3&&(n.push(r),a+=e)}const l=3-i,o=3-a;return l>=0&&o>=0&&l+o===t&&i<=3&&a<=3&&this.isTeamClassCompatible(s)&&this.isTeamClassCompatible(n)?{team1:s,team2:n}:null}static splitIntoTeamsWithAIGreedyClassCheck(e,t){const s=[],n=[];let i=0,a=0;for(const r of e){const e=r.playerCount;i+e<=3&&this.canAddToTeam(s,r)?(s.push(r),i+=e):a+e<=3&&this.canAddToTeam(n,r)&&(n.push(r),a+=e)}const l=3-i,o=3-a;return l>=0&&o>=0&&l+o===t&&i<=3&&a<=3&&this.isTeamClassCompatible(s)&&this.isTeamClassCompatible(n)?{team1:s,team2:n}:null}static canAddToTeam(e,t){return 0===e.length||e.every(e=>e.classId===t.classId)}static isTeamClassCompatible(e){if(e.length<=1)return!0;const t=e[0].classId;return e.every(e=>e.classId===t)}}const l=class e{constructor(e){t(this,"queuedLobbies"),t(this,"onLobbyDelete"),this.queuedLobbies=[],this.onLobbyDelete=e,this.setupEventListeners()}setupEventListeners(){document.addEventListener("lobbyReadyStatusChanged",e=>{const t=e,{lobby:s,allReady:n}=t.detail;n&&!this.isLobbyQueued(s)?this.addLobby(s):!n&&this.isLobbyQueued(s)&&this.removeLobby(s)})}isLobbyQueued(e){return this.queuedLobbies.includes(e)}addLobby(e){this.queuedLobbies.push(e),e.setTimeJoined(Date.now())}removeLobby(e){e.setTimeJoined(0),this.queuedLobbies.splice(this.queuedLobbies.indexOf(e),1)}tick(){this.updateAiEligibility(),this.runMatchAlgorithm(),this.updateLobbyQueueDisplay()}updateAiEligibility(){const t=Date.now();this.queuedLobbies.forEach(s=>{!s.aiEligible&&s.timeJoined>0&&t-s.timeJoined>=e.AI_ELIGIBLE_TIME&&(s.aiEligible=!0)})}updateLobbyQueueDisplay(){const t=document.getElementById("matchQueueList");t&&(t.innerHTML="",this.queuedLobbies.forEach(s=>{const n=document.createElement("div"),i=Date.now()-s.timeJoined,a=Math.floor(i/6e4),l=Math.floor(i%6e4/1e3);let o="";i>=e.AI_ELIGIBLE_TIME_THRESHOLD?(o="[AI-READY]",n.className="queue-lobby queue-lobby-ai-ready"):s.aiEligible?(o="[AI-ELIGIBLE]",n.className="queue-lobby queue-lobby-ai-eligible"):(o="[NO AI]",n.className="queue-lobby queue-lobby-normal");const r=document.createElement("div");r.className="queue-lobby-info",r.textContent="Lobby:"+s.id.toString()+" - P:"+s.playerCount+" - inQ:",r.textContent+=a.toString().padStart(2,"0")+":"+l.toString().padStart(2,"0");const d=document.createElement("div");d.className="queue-lobby-status",d.textContent=o,n.appendChild(r),n.appendChild(d),t.appendChild(n)}))}runMatchAlgorithm(){if(0===this.queuedLobbies.length)return;const t=performance.now();let s=0;for(;s<5&&this.queuedLobbies.length>0;){let t=null;if(t=e.ALLOW_TEAM_CLASS_MIX?i.runMatchAlgorithm(this.queuedLobbies):a.runMatchAlgorithm(this.queuedLobbies),!t)break;this.createMatch(t.team1,t.team2,t.aiPlayers||0),s++}(performance.now()-t).toFixed(2)}createMatch(e,t,s=0){const n=[...e,...t];this.displayMatchResult(e,t,s),n.forEach(e=>{const t=this.queuedLobbies.indexOf(e);t>-1&&(this.queuedLobbies.splice(t,1),e.setTimeJoined(0)),e.id>=0&&this.onLobbyDelete(e.id)})}displayMatchResult(e,t,s=0){const n=document.getElementById("matchResultsList");if(n){const i=document.createElement("div");i.className="match-result";const a=document.createElement("div");a.className="match-teams";const l=this.createTeamElement(e,"team-blue",s),o=this.createTeamElement(t,"team-red",s);a.appendChild(l),a.appendChild(o),i.appendChild(a),n.insertBefore(i,n.firstChild)}}createTeamElement(e,t,s){const n=document.createElement("div");if(n.className=`team-box ${t}`,e.forEach(e=>{const t=this.createLobbyElement(e);n.appendChild(t)}),s>0){const t=3-e.reduce((e,t)=>e+t.playerCount,0);for(let e=0;e<t;e++){const e=this.createAIPlayerElement();n.appendChild(e)}}return n}createLobbyElement(e){const t=document.createElement("div");t.className="match-lobby";const s=e.playerSlots.filter(e=>null!==e).map(e=>e.name).join(", "),n=document.createElement("span");n.textContent=s;const i=document.createElement("span");return i.className="match-lobby-class",i.textContent=`c${e.classId}`,t.appendChild(n),t.appendChild(i),t}createAIPlayerElement(){const e=document.createElement("div");return e.className="match-lobby ai-player",e.textContent=`AI-Bot${Math.floor(1e3*Math.random())}`,e}};t(l,"AI_ELIGIBLE_TIME",5e3),t(l,"AI_ELIGIBLE_TIME_THRESHOLD",15e3),t(l,"ALLOW_TEAM_CLASS_MIX",!1),t(l,"MAX_LOBBIES_PER_SEARCH",150);let o,r=l;class d{constructor(){t(this,"isPaused",!1),t(this,"removeTopBarHandler"),t(this,"lobbies",new Map),t(this,"nextLobbyId",0),t(this,"matcher",new r(e=>this.deleteLobby(e))),this.init()}init(){this.setupTopBarEvents(),this.setupUI(),this.startHeartbeat()}setupUI(){const e=document.getElementById("createLobbyBtn");e&&e.addEventListener("click",()=>this.addLobby(0)),this.setupSettingsPanel()}setupSettingsPanel(){const e=document.getElementById("classMixToggle"),t=document.getElementById("classMixStatus");e&&t&&(this.updateClassMixDisplay(),e.addEventListener("click",()=>{r.ALLOW_TEAM_CLASS_MIX=!r.ALLOW_TEAM_CLASS_MIX,this.updateClassMixDisplay()}));const s=document.getElementById("aiEligibleTimeInput");s&&(s.value=r.AI_ELIGIBLE_TIME.toString(),s.addEventListener("input",()=>{const e=parseInt(s.value);!isNaN(e)&&e>0&&(r.AI_ELIGIBLE_TIME=e)}));const n=document.getElementById("aiReadyTimeInput");n&&(n.value=r.AI_ELIGIBLE_TIME_THRESHOLD.toString(),n.addEventListener("input",()=>{const e=parseInt(n.value);!isNaN(e)&&e>0&&(r.AI_ELIGIBLE_TIME_THRESHOLD=e)}));const i=document.getElementById("addRandomReadyLobbyToGameBtn");i&&i.addEventListener("click",()=>this.addRandomReadyLobby())}updateClassMixDisplay(){const e=document.getElementById("classMixToggle"),t=document.getElementById("classMixStatus");e&&t&&(r.ALLOW_TEAM_CLASS_MIX?(e.classList.add("enabled"),t.textContent="ENABLED"):(e.classList.remove("enabled"),t.textContent="DISABLED"))}addLobby(e){const t=this.nextLobbyId++,s=new n(t,e,e=>this.deleteLobby(e));return this.lobbies.set(t,s),s}deleteLobby(e){const t=this.lobbies.get(e);t&&(this.matcher.isLobbyQueued(t)&&this.matcher.removeLobby(t),t.destroy(),this.lobbies.delete(e))}addRandomReadyLobby(){const e=Math.floor(15*Math.random()),t=this.addLobby(e),n=Math.floor(3*Math.random())+1;for(let i=0;i<n;i++){const e=new s;e.ready=!0,t.addPlayer(e)}}setupTopBarEvents(){const e=e=>{"pause"===e.type?this.togglePause():"menu"===e.type&&this.returnToMainMenu()};document.addEventListener("pause",e),document.addEventListener("menu",e),this.removeTopBarHandler=()=>{document.removeEventListener("pause",e),document.removeEventListener("menu",e)}}togglePause(){this.isPaused=!this.isPaused}destroy(){this.removeTopBarHandler&&this.removeTopBarHandler()}returnToMainMenu(){this.destroy(),window.location.href="/arcade/"}startHeartbeat(){setInterval(()=>{this.updateLobbies()},1e3)}updateLobbies(){this.lobbies.forEach(e=>{e.updateDisplay()}),this.matcher.tick()}}window.returnToMainMenu=()=>null==o?void 0:o.returnToMainMenu(),window.togglePause=()=>null==o?void 0:o.togglePause(),document.addEventListener("DOMContentLoaded",function(){o=new d});
