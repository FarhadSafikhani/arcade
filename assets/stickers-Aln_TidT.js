var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);import"./main-DwgLx9N3.js";import{C as i,b as s,S as r,R as n,c as h,d as a,G as o,e as c,A as p}from"./HTMLText-COKViVEb.js";class d{constructor(t,i,s){e(this,"sprite"),e(this,"id"),e(this,"originX"),e(this,"originY"),e(this,"dragOffset",{x:0,y:0}),e(this,"hole",null),e(this,"inPlay",!1),e(this,"stickerMaker"),e(this,"brightnessFilter"),this.sprite=t,this.id=i,this.originX=t.position.x,this.originY=t.position.y,this.stickerMaker=s,this.makeDraggable(),this.inPlay=!0,this.brightnessFilter=new c,this.sprite.filters=[this.brightnessFilter]}makeDraggable(){this.sprite.eventMode="static",this.sprite.cursor="pointer",this.sprite.on("pointerdown",t=>{if(!this.inPlay)return;const e=t.getLocalPosition(this.sprite.parent);this.dragOffset.x=e.x-this.sprite.position.x,this.dragOffset.y=e.y-this.sprite.position.y,this.sprite.parent.addChild(this.sprite);const i=new CustomEvent("startChunkDrag",{detail:{chunk:this,event:t}});document.dispatchEvent(i)})}checkSnapToHole(){Math.sqrt(Math.pow(this.sprite.position.x-this.originX,2)+Math.pow(this.sprite.position.y-this.originY,2))<u.snapThreshold/u.gideSize&&(this.sprite.position.x=this.originX,this.sprite.position.y=this.originY,this.correctlyPlaced())}onDrop(){this.sprite.position.x<0&&(this.sprite.position.x=0),this.sprite.position.x>this.stickerMaker.gameWidth-this.sprite.width&&(this.sprite.position.x=this.stickerMaker.gameWidth-this.sprite.width),this.sprite.position.y<0&&(this.sprite.position.y=0),this.sprite.position.y>this.stickerMaker.gameHeight-this.sprite.height&&(this.sprite.position.y=this.stickerMaker.gameHeight-this.sprite.height),this.checkSnapToHole()}correctlyPlaced(){performance.now(),this.sprite.alpha=1,this.inPlay=!1,this.sprite.cursor="default",this.sprite.parent.setChildIndex(this.sprite,0);let t=0;const e=i=>{t+=i;const s=Math.min(t/60,1);let r;if(s<.25){const t=s/.25;r=2+t*t*4}else if(s<.9){const t=(s-.25)/1;r=4-3*(1-(1-t)*(1-t))}else r=1;this.brightnessFilter.brightness(r,!1),s>=1&&(this.sprite.filters=[],this.stickerMaker.app.ticker.remove(e))};this.stickerMaker.app.ticker.add(e),this.stickerMaker.createSnapParticles(this.sprite.position.x+this.sprite.width/2,this.sprite.position.y+this.sprite.height/2),performance.now(),setTimeout(()=>{this.sprite.eventMode="none"},1e3)}}class l{constructor(t,i,s){e(this,"id"),e(this,"chunk"),e(this,"graphics"),this.id=i,this.chunk=s,this.graphics=t}}class g{constructor(t,s,r,n){e(this,"app"),e(this,"gameContainer"),e(this,"currentStickerSprite",null),e(this,"gameWidth"),e(this,"gameHeight"),e(this,"holeContainer"),e(this,"chunkContainer"),e(this,"chunks",{}),e(this,"holes",{}),e(this,"activeChunk",null),this.app=t,this.gameContainer=s,this.gameWidth=r,this.gameHeight=n,this.holeContainer=new i,this.chunkContainer=new i,this.setupStickerMakerEvents()}setupStickerMakerEvents(){document.addEventListener("startChunkDrag",t=>{const e=t,{chunk:i,event:s}=e.detail;this.handleStartDrag(i,s)})}handleStartDrag(t,e){this.activeChunk||(this.activeChunk=t)}async createSticker(t){performance.now();const e=await s.load(t);this.currentStickerSprite=new r(e);const i=.9*this.gameWidth,n=.9*this.gameHeight;if(this.currentStickerSprite.width>i||this.currentStickerSprite.height>n){const t=i/this.currentStickerSprite.width,e=n/this.currentStickerSprite.height,s=Math.min(t,e);this.currentStickerSprite.scale.set(s)}this.currentStickerSprite.anchor.set(.5,.5),this.currentStickerSprite.position.set(this.gameWidth/2,this.gameHeight/2),this.gameContainer.addChild(this.currentStickerSprite),this.gameContainer.addChild(this.holeContainer),this.gameContainer.addChild(this.chunkContainer),this.cutIntoTrianglesAndSquares(e),performance.now(),this.shuffleChunks()}cutIntoTrianglesAndSquares(t){const e=n.create({width:t.width,height:t.height}),i=new r(t);this.app.renderer.render(i,{renderTexture:e});const s=this.app.renderer.extract.canvas(e),h=s.getContext("2d").getImageData(0,0,s.width,s.height).data,a=u.gideSize,o=t.width/a,c=t.height/a;for(let r=0;r<a;r++)for(let e=0;e<a;e++){const i=Math.round(e*o),n=Math.round(r*c),a=Math.round((e+1)*o),p=Math.round((r+1)*c);Math.random()>.5?this.createDraggableSquareFromTexture(i,n,a,p,t,h,s.width,s.height):Math.random()>.5?(this.createDraggableTriangleFromTexture(i,n,a,n,i,p,t,h,s.width,s.height),this.createDraggableTriangleFromTexture(a,n,a,p,i,p,t,h,s.width,s.height)):(this.createDraggableTriangleFromTexture(i,n,a,n,a,p,t,h,s.width,s.height),this.createDraggableTriangleFromTexture(i,n,a,p,i,p,t,h,s.width,s.height))}e.destroy(!0)}isPointInTriangleSimple(t,e,i,s,r,n,h,a){const o=(t-r)*(s-n)-(i-r)*(e-n),c=(t-h)*(n-a)-(r-h)*(e-a),p=(t-i)*(a-s)-(h-i)*(e-s);return!((o<0||c<0||p<0)&&(o>0||c>0||p>0))}createDraggableSquareFromTexture(t,e,i,s,n,o,c,p){if(!this.currentStickerSprite)throw new Error("Sticker sprite not found");let l=0;const g=(i-t)*(s-e);for(let r=e;r<s;r++)for(let e=t;e<i;e++)o[4*(r*c+e)+3]>128&&l++;if(l/g<u.visiblePercentage)return;const m=new h(t,e,i-t,s-e),k=new a(n.baseTexture,m),w=new r(k),S=this.currentStickerSprite.position.x-this.currentStickerSprite.width/2,M=this.currentStickerSprite.position.y-this.currentStickerSprite.height/2;w.position.set(S+t*this.currentStickerSprite.scale.x,M+e*this.currentStickerSprite.scale.y),w.scale.set(this.currentStickerSprite.scale.x,this.currentStickerSprite.scale.y);const f=new d(w,`chunk_${Object.keys(this.chunks).length+1}`,this);this.chunks[f.id]=f,this.chunkContainer.addChild(w),this.paintHoleFromSprite(f,i-t,s-e)}createDraggableTriangleFromTexture(t,e,i,s,r,n,c,p,l,g){if(!this.currentStickerSprite)throw new Error("Sticker sprite not found.");const m=Math.min(t,i,r),k=Math.min(e,s,n),w=Math.max(t,i,r),S=Math.max(e,s,n);let M=0,f=0;for(let h=k;h<=S;h++)for(let a=m;a<=w;a++)this.isPointInTriangleSimple(a,h,t,e,i,s,r,n)&&(f++,p[4*(h*l+a)+3]>128&&M++);if(0===f)return;if(M/f<u.visiblePercentage)return;const C=Math.min(t,i,r),v=Math.min(e,s,n),x=Math.max(t,i,r),y=Math.max(e,s,n),T=new h(C,v,x-C,y-v),b=new a(c.baseTexture,T),H=new o;H.beginTextureFill({texture:b}),H.moveTo(t-C,e-v),H.lineTo(i-C,s-v),H.lineTo(r-C,n-v),H.lineTo(t-C,e-v),H.endFill();const D=this.currentStickerSprite.position.x-this.currentStickerSprite.width/2,P=this.currentStickerSprite.position.y-this.currentStickerSprite.height/2;H.position.set(D+C*this.currentStickerSprite.scale.x,P+v*this.currentStickerSprite.scale.y),H.scale.set(this.currentStickerSprite.scale.x,this.currentStickerSprite.scale.y);const F=new d(H,`chunk_${Object.keys(this.chunks).length+1}`,this);this.chunks[F.id]=F,this.chunkContainer.addChild(H),this.paintHoleFromSprite(F,x-C,y-v)}paintHoleFromSprite(t,e,i){if(!this.currentStickerSprite)throw new Error("Sticker sprite not found");let s;s=t.sprite instanceof r?new r(t.sprite.texture):t.sprite.clone(),s.position.set(0,0),s.scale.set(1,1);const h=n.create({width:e,height:i});this.app.renderer.render(s,{renderTexture:h});const a=this.app.renderer.extract.canvas(h).getContext("2d").getImageData(0,0,e,i).data,c=Math.floor(156*Math.random())+50<<16|Math.floor(156*Math.random())+50<<8|Math.floor(156*Math.random())+50,p=new o;for(let r=0;r<i;r++)for(let i=0;i<e;i++)a[4*(r*e+i)+3]>200&&(p.beginFill(c),p.drawRect(t.sprite.position.x+i*t.sprite.scale.x,t.sprite.position.y+r*t.sprite.scale.y,1,1),p.endFill());this.holeContainer.addChild(p);const d=new l(p,t.id,t);this.holes[t.id]=d,t.hole=d,h.destroy(!0)}shuffleChunks(){if(!this.currentStickerSprite)return;const t=.1*this.gameWidth;for(const e of Object.values(this.chunks)){const i=Math.random()>.5;e.sprite.position.x=i?Math.random()*t:this.gameWidth-t+Math.random()*t,e.sprite.position.y=Math.random()*this.gameHeight,e.sprite.position.x<0&&(e.sprite.position.x=0),e.sprite.position.x>this.gameWidth-e.sprite.width&&(e.sprite.position.x=this.gameWidth-e.sprite.width),e.sprite.position.y<0&&(e.sprite.position.y=0),e.sprite.position.y>this.gameHeight-e.sprite.height&&(e.sprite.position.y=this.gameHeight-e.sprite.height)}}onMove(t){if(this.activeChunk){const e=t.getLocalPosition(this.activeChunk.sprite.parent);this.activeChunk.sprite.position.x=e.x-this.activeChunk.dragOffset.x,this.activeChunk.sprite.position.y=e.y-this.activeChunk.dragOffset.y}}onUp(){this.activeChunk&&(this.activeChunk.onDrop(),this.activeChunk=null)}createSnapParticles(t,e){for(let i=0;i<30;i++){const s=new o,r=4*Math.random()+2;s.beginFill(16777215),s.drawCircle(0,0,r),s.endFill(),s.position.set(t,e);const n=2*Math.PI*i/30+.8*(Math.random()-.5),h=3*Math.random()+4,a=Math.cos(n)*h,c=Math.sin(n)*h;this.gameContainer.addChild(s);let p=30;const d=.3;let l=a,g=c;const u=t=>{p-=t,g+=d*t,s.position.x+=l*t,s.position.y+=g*t,s.alpha=p/30;const e=p/30+.1;s.scale.set(e),p<=0&&(this.app.ticker.remove(u),this.gameContainer.removeChild(s),s.destroy())};this.app.ticker.add(u)}}}const u={gideSize:5,snapThreshold:100,visiblePercentage:.1},m=()=>({gameWidth:window.innerWidth,gameHeight:window.innerHeight-60,topBarHeight:60,scale:1});class k{constructor(t){e(this,"app"),e(this,"gameContainer"),e(this,"stickerMaker"),e(this,"removeTopBarHandler"),e(this,"gameDimensions"),this.app=t,this.gameContainer=new i,this.gameDimensions=m(),this.stickerMaker=new g(this.app,this.gameContainer,this.gameDimensions.gameWidth,this.gameDimensions.gameHeight),this.app.stage.addChild(this.gameContainer),this.setupGlobalPointerEvents()}async init(){this.createBackground(),await this.stickerMaker.createSticker("/arcade/assets/stickers/lion.png"),this.setupTopBarEvents()}createBackground(){const t=new o;t.beginFill(16777215),t.drawRect(0,0,this.gameDimensions.gameWidth,this.gameDimensions.gameHeight),t.endFill(),this.gameContainer.addChild(t)}setupTopBarEvents(){const t=t=>{"pause"===t.type?this.togglePause():"menu"===t.type&&this.returnToMainMenu()};document.addEventListener("pause",t),document.addEventListener("menu",t),this.removeTopBarHandler=()=>{document.removeEventListener("pause",t),document.removeEventListener("menu",t)}}update(t){}togglePause(){}destroy(){this.removeTopBarHandler&&this.removeTopBarHandler(),this.app.stage.removeChild(this.gameContainer),this.gameContainer.destroy({children:!0})}returnToMainMenu(){window.location.href="/arcade/"}setupGlobalPointerEvents(){this.app.stage.eventMode="static",this.app.stage.on("pointermove",t=>{this.stickerMaker.onMove(t)}),this.app.stage.on("pointerup",()=>{this.stickerMaker.onUp()}),this.app.stage.on("pointerupoutside",()=>{this.stickerMaker.onUp()}),this.app.view.oncontextmenu=t=>t.preventDefault()}}function w(){const t=document.querySelector("canvas");if(t){const e=m();t.style.width=`${e.gameWidth}px`,t.style.height=`${e.gameHeight}px`}}window.isInit=!1,window.addEventListener("load",async function(){if(window.isInit)return;window.isInit=!0;const t=m(),e=new p({width:t.gameWidth,height:t.gameHeight,backgroundColor:16777215,antialias:!0,resolution:window.devicePixelRatio||1}),i=document.getElementById("gameContainer");i&&i.appendChild(e.view),w();const s=new k(e);await s.init(),e.ticker.add(t=>{s.update(t)}),window.addEventListener("resize",()=>{w()}),window.restartGame=()=>{},window.returnToMainMenu=()=>{s.returnToMainMenu()},window.resumeGame=()=>{},window.togglePause=()=>{s.togglePause()}});
